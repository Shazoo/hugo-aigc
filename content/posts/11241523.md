+++
title = "Python代码为什么在函数中运行更快？"
slug = "Python代码为什么在函数中运行更快？"
date = "2023-08-25T08:17:25+08:00"
tags = [ "cpython", "benchmarking", "profiling", "performance", "python",]
thumbnail = "/images/python.256x256.png"
featureImage = "/images/python.256x256.png"
+++


## 摘要

本教程将解释为什么将Python代码放在一个函数中可以提高代码的执行速度。我们将使用具体的例子来说明这个问题。

## 内容

在将代码放在函数中之前，先看一下不同情况的代码执行时间。

下面是将代码放在函数中的情况：
```python
def main():
    for i in xrange(10**8):
        pass
main()
```

运行结果如下（注：此处是在Linux的BASH中使用time函数进行计时）：
```
real    0m1.841s
user    0m1.828s
sys     0m0.012s
```

而将相同的循环代码放在函数之外，则运行时间更长：
```python
for i in xrange(10**8):
    pass
```

运行结果如下：
```
real    0m4.543s
user    0m4.524s
sys     0m0.012s
```

为什么会出现这种情况呢？

## 总结

代码在函数中运行更快的原因是因为CPython的优化实现。在编译函数时，局部变量被存储在一个固定大小的数组中，而局部变量名则被分配给相应的索引。这种方式加快了对局部变量的访问速度。相比之下，全局变量的访问需要进行哈希查找等操作，速度相对较慢。

通过函数内外代码的比较，我们可以看到存储局部变量的方式比存储全局变量的方式更高效。此外，CPython还针对局部变量的访问进行了一定的优化，包括对下一个操作码的预测。这些优化减少了操作码执行的开销，进一步提高了代码的运行速度。

结合对字节码的分析和源代码的解释，我们可以更好地理解为什么将代码放在函数中可以提高其执行效率。

更多关于CPython虚拟机实现的信息可以参考Python的官方文档中关于CPython虚拟机的介绍。


